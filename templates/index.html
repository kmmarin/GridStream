<!DOCTYPE html>
<html>
<head>
    <title>GridStream | NVENC Orchestrator</title>
    <style>
        :root { --primary: #76b900; --dark: #0a0a0a; --card: #1e1e1e; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--dark); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: #000; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); flex-shrink: 0; }
        .tab-container { display: flex; background: #000; padding: 10px 10px 0 10px; gap: 5px; border-bottom: 1px solid #333; overflow-x: auto; flex-shrink: 0; }
        .tab { padding: 10px 20px; background: #252525; border-radius: 8px 8px 0 0; cursor: pointer; border: none; color: #888; white-space: nowrap; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #444; }
        .dot.online { background: #76b900; box-shadow: 0 0 5px #76b900; }
        .content-area { flex: 1; padding: 20px; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--primary); }
        .stat-value { font-size: 1.8em; font-weight: bold; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #252525; color: var(--primary); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select { width: 100%; padding: 8px; background: #111; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        label { font-size: 12px; color: #aaa; margin-bottom: 4px; display: block; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; text-decoration: none; font-size: 13px; }
        .btn-green { background: var(--primary); color: black; }
        .btn-red { background: #ff4444; color: white; }
        .btn-blue { background: #007bff; color: white; }
        .btn-dark { background: #444; color: white; }
        pre { background: black; color: #00ff00; padding: 10px; height: 180px; overflow-y: auto; font-size: 11px; border-radius: 4px; border: 1px solid #333; margin: 0; flex-grow: 1; }
        .cmd-box { font-family: monospace; font-size: 10px; color: #888; background: #000; padding: 8px; border-radius: 4px; word-break: break-all; margin-top: 8px; }
        .monitor-row { display: flex; gap: 15px; margin-top: 20px; align-items: flex-start; }
        .video-box { width: 320px; height: 200px; background: #000; border-radius: 4px; border: 1px solid #333; position: relative; flex-shrink: 0; overflow: hidden; }
        .reload-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .reload-btn:hover { background: var(--primary); color: black; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <h3 style="margin:0; color:var(--primary); letter-spacing: 1px;">GRIDSTREAM</h3>
        <form method="post"><input type="hidden" name="action" value="add"><button class="btn btn-green">+ New Encoder</button></form>
    </div>
    <div style="display:flex; gap:10px;">
        <form method="post"><input type="hidden" name="action" value="start_all"><button class="btn btn-green">‚ñ∂ Start Saved</button></form>
        <form method="post"><input type="hidden" name="action" value="stop_all"><button class="btn btn-red">‚èπ Stop All</button></form>
    </div>
</header>

<div class="tab-container">
    <button class="tab {% if active_tab == 'dashboard' %}active{% endif %}" onclick="location.href='/?active_tab=dashboard'">üìä Dashboard</button>
    {% for s in streams.values() %}
    <button class="tab {% if active_tab|string == s.id|string %}active{% endif %}" onclick="location.href='/?active_tab={{s.id}}'">
        <span class="dot tab-dot-{{s.id}} {{ 'online' if s.proc else '' }}"></span>
        {{ s.fields.stream_name }}
    </button>
    {% endfor %}
</div>

<div class="content-area">
    <div id="tab-dashboard" class="tab-content {% if active_tab == 'dashboard' %}active{% endif %}">
        <div class="stats-grid">
            <div class="stat-card"><div>CPU</div><div class="stat-value" id="cpu-val">0%</div></div>
            <div class="stat-card"><div>GPU Load</div><div class="stat-value" id="gpu-load">0%</div></div>
            <div class="stat-card"><div>GPU Temp</div><div class="stat-value" id="gpu-temp">0¬∞C</div></div>
            <div class="stat-card"><div>Net Out</div><div class="stat-value" id="net-sent">0 MB</div></div>
        </div>
        <table>
            <thead><tr><th>Stream Name</th><th>Codec</th><th>Status</th><th>Management</th></tr></thead>
            <tbody>
                {% for s in streams.values() %}
                <tr>
                    <td>{{ s.fields.stream_name }}</td>
                    <td>{{ s.fields.codec }}</td>
                    <td id="status-text-{{s.id}}">{{ 'üü¢ Running' if s.proc else '‚ö™ Stopped' }}</td>
                    <td><a href="/?active_tab={{s.id}}" class="btn btn-green">Manage</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% for s in streams.values() %}
    <div id="tab-{{s.id}}" class="tab-content {% if active_tab|string == s.id|string %}active{% endif %}">
        <div style="background: var(--card); padding: 20px; border-radius: 8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Settings: {{ s.fields.stream_name }}</h2>
                <div style="display:flex; align-items:center; gap:10px; background:#000; padding:5px 15px; border-radius:20px;">
                    <span class="dot tab-dot-{{s.id}} {{ 'online' if s.proc else '' }}"></span>
                    <span id="header-status-{{s.id}}">{{ 'RUNNING' if s.proc else 'STOPPED' }}</span>
                </div>
            </div>
            
            <form method="post">
                <input type="hidden" name="stream_id" value="{{ s.id }}">
                <input type="hidden" name="action" id="act{{ s.id }}">
                <div class="grid">
                    <div><label>Source URI</label><input name="input" value="{{ s.fields.input }}" placeholder="rtsp://..."></div>
                    <div><label>Stream Name</label><input name="stream_name" value="{{ s.fields.stream_name }}"></div>
                    <div><label>NVENC Codec</label>
                        <select name="codec">
                            <option value="copy" {% if s.fields.codec == 'copy' %}selected{% endif %}>Direct Copy (No Re-encode)</option>
                            <option value="h264" {% if s.fields.codec == 'h264' %}selected{% endif %}>H.264 NVENC</option>
                            <option value="hevc" {% if s.fields.codec == 'hevc' %}selected{% endif %}>HEVC (H.265) NVENC</option>
                        </select>
                    </div>
                    <div><label>Destination RTSP</label><input name="destination" value="{{ s.fields.destination }}"></div>
                    <div><label>Bitrate (kbps)</label><input name="bitrate" value="{{ s.fields.bitrate }}"></div>
                    <div><label>Frame Rate</label><input name="fps" value="{{ s.fields.fps }}"></div>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button type="submit" class="btn btn-green" onclick="set({{s.id}}, 'start')">START</button>
                    <button type="submit" class="btn btn-red" onclick="set({{s.id}}, 'stop')">STOP</button>
                    <button type="submit" class="btn btn-blue" onclick="set({{s.id}}, 'save')">SAVE</button>
                    <button type="submit" class="btn btn-dark" onclick="set({{s.id}}, 'toggle_preview')">Toggle Video</button>
                    <button type="submit" class="btn btn-dark" onclick="set({{s.id}}, 'toggle_console')">Toggle Console</button>
                    <button type="submit" class="btn btn-red" style="margin-left:auto" onclick="return confirm('Permanently delete this encoder?') ? set({{s.id}}, 'delete') : false">DELETE</button>
                </div>
            </form>
            
            {% if s.proc %}
            <div class="monitor-row">
                {% if s.show_preview %}
                <div class="video-box">
                    <button class="reload-btn" onclick="manualReload({{s.id}})">‚Üª</button>
                    <video id="vid-{{s.id}}" controls autoplay muted style="width: 100%; height: 100%; object-fit: contain;" onerror="retryVideo(this)">
                        <source src="/preview/{{ s.preview }}?cb={{ range(1, 99999) | random }}" type="application/vnd.apple.mpegurl">
                    </video>
                </div>
                {% endif %}

                {% if s.show_console %}
                <div style="flex-grow: 1; min-width: 0; display: flex; flex-direction: column;">
                    <pre id="log{{ s.id }}"></pre>
                    <div class="cmd-box"><strong>Active Command:</strong> {{ s.cmd }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
function set(id, a){ document.getElementById("act"+id).value=a; }

function manualReload(id) {
    const video = document.getElementById('vid-' + id);
    if (video) {
        const source = video.querySelector('source');
        const url = new URL(source.src);
        url.searchParams.set('reload', Date.now());
        source.src = url.href;
        video.load();
    }
}

function retryVideo(video) {
    setTimeout(() => {
        const source = video.querySelector('source');
        if (source) {
            const url = new URL(source.src);
            url.searchParams.set('retry', Date.now());
            source.src = url.href;
            video.load();
        }
    }, 2500);
}

setInterval(() => {
    fetch('/api/stats').then(r => r.json()).then(data => {
        document.getElementById('cpu-val').textContent = data.system.cpu + '%';
        document.getElementById('gpu-load').textContent = data.system.gpu_load;
        document.getElementById('gpu-temp').textContent = data.system.gpu_temp;
        document.getElementById('net-sent').textContent = data.system.net_sent + ' MB';
        
        for (const [sid, isOnline] of Object.entries(data.active_map)) {
            const dots = document.querySelectorAll('.tab-dot-' + sid);
            dots.forEach(d => isOnline ? d.classList.add('online') : d.classList.remove('online'));
            const txt = document.getElementById('status-text-' + sid);
            if(txt) txt.textContent = isOnline ? 'üü¢ Running' : '‚ö™ Stopped';
            const headTxt = document.getElementById('header-status-' + sid);
            if(headTxt) headTxt.textContent = isOnline ? 'RUNNING' : 'STOPPED';
        }
    });
}, 2000);

{% for s in streams.values() %}
setInterval(()=>{
    fetch("/logs/{{ s.id }}").then(r=>r.json()).then(d=>{
        let e=document.getElementById("log{{ s.id }}");
        if(e && d.length > 0){ e.textContent = d.join("\n"); e.scrollTop = e.scrollHeight; }
    });
}, 2000);
{% endfor %}
</script>
</body>
</html>
