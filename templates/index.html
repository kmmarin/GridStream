<!DOCTYPE html>
<html>
<head>
    <title>GRIDSTREAM ENCODER</title>
    <style>
        :root { --primary: #76b900; --bg: #0a0a0a; --card: #161616; --sidebar: #111; }
        body { background: var(--bg); color: #eee; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Navigation */
        nav { width: 300px; background: var(--sidebar); height: 100vh; border-right: 1px solid #333; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        .nav-header { color: white; margin-bottom: 30px; font-weight: bold; font-size: 22px; letter-spacing: 1px; }
        .nav-item { padding: 12px 15px; border-radius: 6px; cursor: pointer; color: #888; text-decoration: none; display: block; margin-bottom: 5px; transition: 0.2s; }
        .nav-item:hover { background: #1a1a1a; color: var(--primary); }
        .active-nav { color: var(--primary); background: #1a1a1a; border-left: 4px solid var(--primary); font-weight: bold; }

        /* Main Content Area */
        main { flex: 1; padding: 40px; overflow-y: auto; box-sizing: border-box; }
        .stats-bar { display: flex; gap: 15px; margin-bottom: 30px; }
        .stats-bar span { background: #1a1a1a; padding: 8px 15px; border-radius: 6px; border: 1px solid #333; font-size: 13px; color: #aaa; }
        
        /* Configuration Card */
        .card { background: var(--card); border: 1px solid #333; padding: 30px; border-radius: 10px; max-width: 900px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { margin-top: 0; font-size: 28px; }
        
        label { display: block; margin-bottom: 8px; font-size: 14px; color: #888; font-weight: bold; text-transform: uppercase; }
        input, select { 
            background: #222; color: white; border: 1px solid #444; padding: 12px; 
            margin-bottom: 25px; width: 100%; border-radius: 6px; box-sizing: border-box; font-size: 15px;
        }
        input:focus { border-color: var(--primary); outline: none; background: #2a2a2a; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 12px; align-items: center; }
        .btn { padding: 12px 24px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; transition: 0.2s; text-transform: uppercase; }
        .btn-start { background: var(--primary); color: black; }
        .btn-stop { background: #cc0000; color: white; }
        .btn-save { background: #333; color: white; border: 1px solid #444; }
        .btn-delete { background: transparent; color: #666; font-size: 12px; }
        .btn-delete:hover { color: #ff4444; }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }

        /* Log Console */
        .console-header { margin-top: 30px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .console { 
            background: #000; color: #00ff00; font-family: 'Consolas', 'Monaco', monospace; 
            padding: 20px; height: 350px; overflow-y: auto; font-size: 13px; 
            border-radius: 8px; border: 1px solid #333; line-height: 1.5;
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-header">GRIDSTREAM</div>
    
    <form method="POST">
        <button name="action" value="add" class="btn btn-start" style="width: 100%; margin-bottom: 20px;">+ NEW ENCODER</button>
    </form>
    
    <a href="/?active_tab=dashboard" class="nav-item {% if request.args.get('active_tab') == 'dashboard' or not request.args.get('active_tab') %}active-nav{% endif %}">
        üìä Dashboard
    </a>
    
    <div style="margin: 25px 0 10px 10px; font-size: 11px; color: #555; font-weight: bold; letter-spacing: 1px;">ACTIVE ENCODERS</div>
    {% for sid, s in streams.items() %}
    <a href="/?active_tab={{ sid }}" class="nav-item {% if request.args.get('active_tab') == sid|string %}active-nav{% endif %}">
        ‚Ä¢ {{ s.fields.stream_name or 'Untitled Stream' }}
    </a>
    {% endfor %}
</nav>

<main>
    {% set active_sid = request.args.get('active_tab', 'dashboard') %}

    <div class="stats-bar" id="stats-container">
        <span>CPU: {{ stats.cpu }}%</span>
        <span>RAM: {{ stats.ram }}%</span>
        <span>GPU Load: {{ stats.gpu_load }}</span>
        <span>GPU Temp: {{ stats.gpu_temp }}</span>
    </div>

    {% if active_sid == 'dashboard' %}
        <h1>System Overview</h1>
        <p style="color: #666;">Welcome to the GridStream control panel. Use the sidebar to create new encoder instances or manage existing relays.</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 40px;">
            <div class="card" style="padding: 20px;">
                <h3 style="margin-top:0">Active Streams</h3>
                <h2 style="color: var(--primary); margin: 0;">{{ streams|length }}</h2>
            </div>
        </div>

    {% else %}
        {% set s = streams[active_sid|int] %}
        <h1>{{ s.fields.stream_name }}</h1>
        
        <div class="card">
            <form method="POST">
                <input type="hidden" name="stream_id" value="{{ active_sid }}">
                
                <label>Input Source (RTSP/RTMP)</label>
                <input type="text" name="input" value="{{ s.fields.input }}" placeholder="rtsp://admin:password@192.168.1.50/stream1" autocomplete="off">
                
                <label>Stream Key / Name (Used in Destination URL)</label>
                <input type="text" name="stream_name" value="{{ s.fields.stream_name }}" placeholder="cam_office" autocomplete="off">
                
                <label>Hardware Encoding Mode</label>
                <select name="codec">
                    <option value="copy" {% if s.fields.codec == 'copy' %}selected{% endif %}>Direct Copy (Zero CPU Load)</option>
                    <option value="h264" {% if s.fields.codec == 'h264' %}selected{% endif %}>NVIDIA NVENC H.264</option>
                    <option value="hevc" {% if s.fields.codec == 'hevc' %}selected{% endif %}>NVIDIA NVENC HEVC (H.265)</option>
                </select>
                
                <label>Destination RTSP Server</label>
                <input type="text" name="destination" value="{{ s.fields.destination }}" placeholder="rtsp://172.16.0.137:8554" autocomplete="off">

                <div class="btn-group">
                    <button name="action" value="start" class="btn btn-start">‚ñ∂ Start Encoder</button>
                    <button name="action" value="stop" class="btn btn-stop">‚èπ Stop</button>
                    <button name="action" value="save" class="btn btn-save">üíæ Save Settings</button>
                    <button name="action" value="delete" class="btn btn-delete" onclick="return confirm('Delete this encoder?')">Delete Encoder</button>
                </div>
            </form>

            <div class="console-header">
                <label>Live FFmpeg Output</label>
                <span id="status-indicator" style="font-size: 12px; color: #555;">Checking status...</span>
            </div>
            <div class="console" id="console">
                {% for line in s.log %}{{ line }}<br>{% endfor %}
            </div>
        </div>
    {% endif %}
</main>

<script>
    const activeSid = "{{ active_sid }}";

    async function refreshData() {
        // 1. Refresh Global Stats
        try {
            const statsRes = await fetch('/api/stats');
            const stats = await statsRes.json();
            document.getElementById('stats-container').innerHTML = `
                <span>CPU: ${stats.cpu}%</span>
                <span>RAM: ${stats.ram}%</span>
                <span>GPU Load: ${stats.gpu_load}</span>
                <span>GPU Temp: ${stats.gpu_temp}</span>
            `;
        } catch (e) { console.error("Stats fail"); }

        // 2. Refresh Logs (Only if on a specific stream tab)
        if (activeSid !== "dashboard") {
            try {
                const logRes = await fetch(`/api/logs/${activeSid}`);
                const data = await logRes.json();
                const consoleBox = document.getElementById('console');
                const statusIndicator = document.getElementById('status-indicator');
                
                if (consoleBox && data.log) {
                    // Check if user is scrolled to bottom before updating
                    const isAtBottom = consoleBox.scrollHeight - consoleBox.clientHeight <= consoleBox.scrollTop + 10;
                    
                    consoleBox.innerHTML = data.log.join('<br>');
                    
                    if (isAtBottom) {
                        consoleBox.scrollTop = consoleBox.scrollHeight;
                    }
                }

                if (statusIndicator) {
                    statusIndicator.innerHTML = data.running ? 
                        '<span style="color:var(--primary)">‚óè RUNNING</span>' : 
                        '<span style="color:#666">‚óè STOPPED</span>';
                }
            } catch (e) { console.error("Log fetch fail"); }
        }
    }

    // Auto-refresh stats and logs every 3 seconds
    setInterval(refreshData, 3000);

    // Initial scroll to bottom
    const box = document.getElementById('console');
    if (box) box.scrollTop = box.scrollHeight;
</script>

</body>
</html>
