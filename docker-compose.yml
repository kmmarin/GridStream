version: '3.8'

services:
  # Main Encoder App
  gridstream:
    build: .
    container_name: gridstream
    ports:
      - "8080:8080"
    volumes:
      - .:/app
      - /tmp/gridstream_preview:/tmp/gridstream_preview
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, video]

  # New Viewer App
  gridstream-viewer:
    build: .
    container_name: gridstream-viewer
    restart: unless-stopped
    command: python3 viewer_app.py
    ports:
      - "8081:8081"
    volumes:
      - .:/app
      - ./streams.json:/app/streams.json  # Shared config
    depends_on:
      - gridstream
