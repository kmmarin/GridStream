version: '3.8'

services:
  gridstream:
    build: .
    container_name: gridstream
    # This forces the NVIDIA bridge even if it's not the default system runtime
    runtime: nvidia
    network_mode: host
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    volumes:
      - .:/app
      - /tmp/gridstream_preview:/tmp/gridstream_preview
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video, compute]

  gridstream-viewer:
    build: .
    container_name: gridstream-viewer
    restart: unless-stopped
    network_mode: host
    command: python3 viewer_app.py
    volumes:
      - .:/app
      - ./streams.json:/app/streams.json
    depends_on:
      - gridstream
